<!DOCTYPE html>
<html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <title>
      lukaszkups.net - Saving API images in Meteor apps
    </title>
    <meta content='lukaszkups.net - front-end development, branding, design' name='description'>
    <link href='/stylesheet/stylesheet.css' media='screen' rel='stylesheet' type='text/css'>
    <script src='http://code.jquery.com/jquery-latest.min.js' type='text/javascript'></script>
    <script src='/javascripts/bracketslider.js' type='text/javascript'></script>
    <meta content='nanoc 3.1.6' name='generator'>
    <link href='/images/favicon.ico' rel='shortcut icon'>
    <meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0' name='viewport'>
    <link href='/images/favicon.png' rel='shortcut icon' type='image/png'>
    <link href='http://lukaszkups.net/images/favicon.png' rel='shortcut icon' type='image/png'>
    <link href='http://fonts.googleapis.com/css?family=Lato|Droid+Sans|Roboto+Slab:300|Open+Sans' rel='stylesheet' type='text/css'>
    <meta content='http://lukaszkups.net/images/logo.jpg' property='og:image'>
    <link href='/stylesheet/highlightjs_styles.css' rel='stylesheet'>
    <script src='/javascripts/highlight.js'></script>
  </head>
  <body>
    <div class='main-container header'>
      <a class='site-title' href='/'>
        <div class='logo'></div>
        <span class='droid'>
          Front-end engineering.
        </span>
      </a>
      <ul class='main-menu'>
        <li>
          <a href='/experience/'>
            Experience
          </a>
        </li>
        <li>
          <a href='/notes/'>
            Notes
          </a>
        </li>
        <li>
          <a href='/about/'>
            About
          </a>
        </li>
        <li>
          <a href='/contact/'>
            Contact
          </a>
        </li>
      </ul>
    </div>
    <div class='clear clear40'></div>
    <div class='main-container project-container'>
      
      <h1 id="saving-api-images-in-meteor-apps">Saving API images in Meteor apps</h1>
      
      <p>Today I would like to share the knowledge about saving image files from external APIs.</p>
      
      <p>Consider this scenario: <em>You have to develop an mobile app, that downloads some data and files from external API and saves those files locally to work offline if necessary</em>.</p>
      
      <h2 id="packages">Packages</h2>
      
      <p>First, we need to install proper Meteorjs plugins which enables to interact with files (<a href="https://atmospherejs.com/cfs/standard-packages">more info</a>):</p>
      
      <pre><code>&#x000A;meteor add cfs:standard-packages&#x000A;</code></pre>
      
      <p>This is the main set of packages, that will help us dealing with files - I’m very happy that someone did such great job and solved file management problems in really painful way.</p>
      
      <p>Also, we have to install a storage adapter package - my favorite is <a href="https://atmospherejs.com/cfs/gridfs">gridfs</a>. If You’re using newest Meteor version then You should have it merged into Meteor’s core - on the other case You have to install it:</p>
      
      <pre><code>&#x000A;meteor add cfs:gridfs&#x000A;</code></pre>
      
      <h2 id="collection">Collection</h2>
      
      <p>Okay, so we have all necessary tools, now we have to define our file/media collections:</p>
      
      <pre><code>&#x000A;/* lib/models.js */&#x000A;Media = new FS.Collection("media", {&#x000A;  stores: [new FS.Store.GridFS("media")]&#x000A;});&#x000A;</code></pre>
      
      <p>Thanks to <code>/lib/</code> file path, our collection definition will be available both on the server and the client side of the app.</p>
      
      <h2 id="cross-origin-resource-sharing-cors">Cross-Origin Resource Sharing (CORS)</h2>
      
      <p>In this step, we will make sure that we don’t get a <a href="http://www.w3.org/TR/cors/">CORS error</a>. To ensure this, we have to add adequate header to our request:</p>
      
      <pre><code>&#x000A;/* server/private_helpers.js */&#x000A;Meteor.startup(function(){&#x000A;  WebApp.connectHandlers.use(function(req, res, next) {&#x000A;    res.setHeader("Access-Control-Allow-Origin", "*");&#x000A;    return next();&#x000A;  });&#x000A;});&#x000A;</code></pre>
      
      <h2 id="getting-file-via-api">Getting file via API</h2>
      
      <p>Now it’s time to get the file path via our API. You can do this in couple ways - e.g. via Meteor’s <a href="https://atmospherejs.com/meteor/http">HTTP package</a> (<code>meteor add http</code>) or classically - via ajax request.</p>
      
      <p>Personally, I decided to go classy and used jQuery (❤promises):</p>
      
      <pre><code>&#x000A;/* client/public_helpers.js  */&#x000A;&#x000A;var imageArr = [];&#x000A;var getApiFiles = function(){&#x000A;  var dfd = new $.Deferred();&#x000A;  $.ajax({&#x000A;    url: PATH_TO_REMOTE_API,&#x000A;    dataType: 'json'&#x000A;  }).done(function(data){&#x000A;    imageArr = data;&#x000A;    dfd.resolve(imageArr);&#x000A;  }).error(function(error){&#x000A;    console.log('getImage error');&#x000A;  });&#x000A;  return dfd.promise();&#x000A;};&#x000A;</code></pre>
      
      <p>Let’s assume that the response (in our case imageArr) will look like this:</p>
      
      <pre><code>&#x000A;[&#x000A;  {&#x000A;    id: 1,&#x000A;    photo: "/media/image1.jpg",&#x000A;    default: false&#x000A;  },&#x000A;  {&#x000A;    id: 2,&#x000A;    photo: "/media/image2.jpg",&#x000A;    default: false&#x000A;  },&#x000A;    id: 3,&#x000A;    photo: "/media/image3.jpg",&#x000A;    default: true&#x000A;  }&#x000A;]&#x000A;</code></pre>
      
      <h2 id="file-downloading-meteor-method">File downloading Meteor method</h2>
      
      <p>To make everything work, we have to add server side file downloading method:</p>
      
      <pre><code>&#x000A;/* server/private_helpers.js  */&#x000A;Meteor.methods({&#x000A;  saveFile: function(filePath){&#x000A;    var file = new FS.File();&#x000A;    file.attachData(filePath, function(err){&#x000A;      if(err){&#x000A;        throw err;&#x000A;      }&#x000A;      Media.insert(file, function(err, fileObj){&#x000A;        return fileObj._id;&#x000A;      });&#x000A;    });&#x000A;  }&#x000A;});&#x000A;</code></pre>
      
      <h2 id="final-function">Final function</h2>
      
      <p>In the last step, we have to execute our methods properly:</p>
      
      <pre><code>&#x000A;/* client/helpers.js */&#x000A;$.when(getApiFiles()).done(function(){&#x000A;  for(var img in imageArr){&#x000A;    var img_id = Meteor.call('saveFile', "http://remote-domain.xyz" + imageArr[img].photo);&#x000A;&#x000A;    /* here You can process additional features, e.g. attaching img_id to another collection etc. */&#x000A;  }&#x000A;});&#x000A;</code></pre>
      
      <p>And that’s it! Now You can use Your saved files in Your Meteor.js application locally, even without internet connection.</p>
      
      <p>I’ve read couple comments that FS package should not be used in production, but in my opinion it just do the job perfectly. Until Meteor Core Development Team provide an official solution to handle file management You can be sure that I’ll be using these packages - and therefore You should ;)</p>
      
      <p>If You have any questions or suggestions, feel free to <a href="http://lukaszkups.net/contact">contact</a>.</p>
      
      <p>– ł.</p>
    </div>
    <div class='clear clear40'></div>
    <div class='main-container'>
      <div class='footer lato'>
        Copyright &copy; 2009 -
        2015
        Lukasz Kups (
        <a href='http://twitter.com/lukaszkups'>
          @lukaszkups
        </a>
        )
      </div>
    </div>
    <div class='clear clear20'></div>
    <script src='/javascripts/application.js' type='text/javascript'></script>
    <script src='/javascripts/blog.js' type='text/javascript'></script>
  </body>
</html>
